version: '3.8'

services:
    # OpenTelemetry Collector
    otel-collector:
        image: otel/opentelemetry-collector-contrib:0.91.0
        container_name: otel-collector
        command: ['--config=/etc/otel-collector-config.yml']
        volumes:
            - ./config/otel-config.yml:/etc/otel-collector-config.yml
        ports:
            - '4317:4317' # OTLP gRPC receiver
            - '4318:4318' # OTLP http receiver
            - '8888:8888' # Prometheus metrics exposed by the collector
            - '8889:8889' # Prometheus exporter metrics
        depends_on:
            - tempo
            - loki
            - prometheus
        networks:
            - observability

    # Prometheus
    prometheus:
        image: prom/prometheus:v2.48.1
        container_name: prometheus
        command:
            - '--config.file=/etc/prometheus/prometheus.yml'
            - '--storage.tsdb.path=/prometheus'
            - '--web.console.libraries=/etc/prometheus/console_libraries'
            - '--web.console.templates=/etc/prometheus/consoles'
            - '--storage.tsdb.retention.time=200h'
            - '--web.enable-lifecycle'
            - '--enable-feature=exemplar-storage'
        volumes:
            - ./config/prometheus.yml:/etc/prometheus/prometheus.yml
            - prometheus_data:/prometheus
        ports:
            - '9090:9090'
        networks:
            - observability

    # Tempo
    tempo:
        image: grafana/tempo:2.3.1
        container_name: tempo
        command: ['-config.file=/etc/tempo.ml']
        volumes:
            - ./config/tempo.yml:/etc/tempo.yml
            - tempo_data:/tmp/tempo
        ports:
            - '3200:3200' # tempo UI
            # Tempoは内部でOTel Collectorから接続を受けるため、外部ポートは不要
        networks:
            - observability

    # Loki
    loki:
        image: grafana/loki:2.9.3
        container_name: loki
        ports:
            - '3100:3100'
        command: -config.file=/etc/loki/config.yml
        volumes:
            - ./config/loki-config.yml:/etc/loki/config.yml
            - loki_data:/loki
        networks:
            - observability

    # Grafana
    grafana:
        image: grafana/grafana:10.2.3
        container_name: grafana
        environment:
            - GF_SECURITY_ADMIN_USER=admin
            - GF_SECURITY_ADMIN_PASSWORD=admin
            - GF_SERVER_ROOT_URL=http://localhost:3000
            - GF_FEATURE_TOGGLES_ENABLE=traceToLogs,traceToMetrics
        volumes:
            - ./config/grafana/datasources:/etc/grafana/provisioning/datasources
            - grafana_data:/var/lib/grafana
        ports:
            - '3000:3000'
        depends_on:
            - prometheus
            - tempo
            - loki
        networks:
            - observability

networks:
    observability:
        name: observability-network
        driver: bridge

volumes:
    prometheus_data:
    tempo_data:
    loki_data:
    grafana_data:
